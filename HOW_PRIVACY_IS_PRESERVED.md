# How Privacy Is Preserved in OpenPCC (v0.002)

Korean version: [HOW_PRIVACY_IS_PRESERVED.ko.md](./HOW_PRIVACY_IS_PRESERVED.ko.md)

This document summarizes how client queries and answers are protected in the
OpenPCC prototype, based on the design notes and configuration in this repo.

## Scope and sources

Sources in this repository:
- ARCHITECTURE.md (primary design description)
- server-2/config/compute_boot.yaml
- server-2/config/router_com.yaml
- HOW-TO-DEPLOY.md
- system_test.sh (local test settings)

Important scope notes:
- This repo includes CLI clients under `client/cli/*`. These CLIs accept relay
  and seed configuration via environment variables or `/etc/nnstreamer/hybrid.ini`
  and do not call `server-3 /api/config` directly.
- Production SDK behavior is defined upstream in OpenPCC.

## Terms (short)

- REK: Request Encryption Key created in the compute enclave (asymmetric key pair;
  public key shared via attestation, private key kept in the TPM).
- DEK: Data Encryption Key generated by the client per request/session (symmetric key
  for encrypting the request payload).
- HPKE: Public key encryption used to wrap the DEK with the REK public key.
- BHTTP: Binary HTTP encoding used for the request payload.
- Attestation: Verification that the compute node runs trusted code.
- TPM: Hardware security module used for attestation and key handling.
- Nitro Enclave: Isolated compute environment for inference.

## High-level privacy model

1) The client obtains routing config either from server-3 (control-plane) or
   local CLI config (env/INI), then verifies the compute node attestation
   evidence (TPM quote, PCRs) which includes the REK public key; the REK private
   key stays inside the TPM.
2) The client encrypts the query:
   - Generate a DEK (symmetric).
   - Encrypt (wrap) the DEK with the REK public key using HPKE.
   - Serialize the prompt as BHTTP and encrypt it using the DEK.
3) With oHTTP enabled, the relay forwards to the gateway, which decapsulates and
   forwards to the router. Without oHTTP, the client sends directly to the router.
   The router forwards the encrypted request without decrypting it.
4) The compute enclave uses the REK private key in TPM to decrypt the DEK, then
   decrypts the prompt, runs inference, and prepares a response.

Note about responses:
- The repository documents request encryption explicitly, but does not specify
  the exact response encryption format. Response protection is therefore
  implementation-defined and must be confirmed in upstream OpenPCC/ConfidentCompute.

## Diagram: encryption, decryption, and transport flow

```mermaid
sequenceDiagram
  autonumber
  participant Client
  participant Relay as Server-4 (Relay)
  participant Gateway as Server-1 (Gateway)
  participant Router as Server-1 (Router)
  participant TPM
  participant Enclave as Server-2 (Compute Enclave)

  Router->>Client: Attestation bundle (TPM quote + PCRs)
  Client->>Client: Verify attestation evidence

  Enclave->>TPM: Create/hold REK handle
  Client->>Client: Generate DEK (per request/session)
  Client->>Client: HPKE encrypt DEK with REK
  Client->>Client: BHTTP serialize prompt
  Client->>Client: Encrypt prompt with DEK

  alt oHTTP enabled
    Client->>Relay: Encapsulated oHTTP request
    Relay->>Gateway: Forward only
    Gateway->>Router: Decapsulated inner request
  else oHTTP disabled
    Client->>Router: Encrypted request (DEK wrapped + ciphertext)
  end
  Router->>Enclave: Forward encrypted request (no decrypt)

  Enclave->>TPM: Use REK to decrypt DEK
  Enclave->>Enclave: Decrypt prompt with DEK
  Enclave->>Enclave: Run inference in enclave

  opt Response protection (implementation-defined)
    Enclave-->>Router: Encrypted response (e.g., with DEK)
    Router-->>Client: Forward response (no decrypt)
  end
```

## Security properties (from design notes)

- Confidentiality in transit: the router cannot read the request content because
  it does not have the DEK and does not decrypt traffic.
- Confidentiality at compute: decryption happens inside the enclave using TPM-
  anchored keys; the host and router do not hold request plaintext keys.
- Attestation-based trust: the client validates TPM quote/PCRs before sending
  sensitive data, ensuring the compute node is a trusted build.
- Hardening: the compute image is expected to use SELinux, dm-verity (read-only
  filesystem), and disable remote access such as SSH (per ARCHITECTURE.md).
- Network segmentation: deployment guidance recommends restricting compute node
  access to only the router security group (HOW-TO-DEPLOY.md).

## Non-production settings and cautions

- Local testing can enable TPM simulators and fake attestation secrets
  (compute_boot.yaml, system_test.sh). These are for development only and should
  be disabled for production deployments.

## Gaps and verification steps

- Response encryption is not described in this repo. Confirm upstream behavior
  in OpenPCC/ConfidentCompute and document the exact response format and keys.
