# Objective: Deploy OpenPCC router and compute nodes to AWS.
# Usage examples:
# - Run workflow_dispatch with component=server-1 and ami_id set
# - Run workflow_dispatch with component=server-2 (EIF builds on instance)
# - Run workflow_dispatch with component=all and required AWS inputs set
name: OpenPCC Proto 1 Deploy

on:
  workflow_dispatch:
    inputs:
      component:
        type: choice
        description: Component to deploy
        options:
          - all
          - server-1
          - server-2
        default: all
      image_tag:
        type: string
        description: Image tag to deploy
        default: ""
      aws_region:
        type: string
        description: AWS region
        default: ""
      subnet_id:
        type: string
        description: Subnet ID for instances
        default: ""
      router_security_group_id:
        type: string
        description: Security group ID for router (server-1)
        default: ""
      compute_security_group_id:
        type: string
        description: Security group ID for compute (server-2)
        default: ""
      instance_profile_arn:
        type: string
        description: Optional IAM instance profile ARN for EC2 (leave blank for public registry pulls)
        default: ""
      image_registry:
        type: string
        description: Public image registry base (e.g., public.ecr.aws/alias) when no instance profile
        default: ""
      key_name:
        type: string
        description: Optional EC2 key pair name
        default: ""
      ami_id:
        type: string
        description: Base AMI ID (Ubuntu 22.04 recommended)
        default: ""
      router_ami_id:
        type: string
        description: Router AMI ID override
        default: ""
      compute_ami_id:
        type: string
        description: Compute AMI ID override
        default: ""
      router_instance_type:
        type: string
        description: Router instance type
        default: ""
      compute_instance_type:
        type: string
        description: Compute instance type (Nitro Enclaves enabled)
        default: ""
      enable_compute_monitor:
        type: boolean
        description: Install compute monitor on server-2 (debug only)
        default: true
      router_address:
        type: string
        description: Optional router address override (for compute-only deploys)
        default: ""
      enclave_cpu_count:
        type: string
        description: Enclave CPU count
        default: ""
      enclave_memory_mib:
        type: string
        description: Enclave memory (MiB)
        default: ""
      enclave_cid:
        type: string
        description: Enclave CID for VSOCK connections
        default: "16"
      tpm_simulator_cmd_port:
        type: string
        description: TPM simulator command port
        default: "2321"
      tpm_simulator_platform_port:
        type: string
        description: TPM simulator platform port (cmd+1)
        default: "2322"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RESOLVED_AWS_REGION: ${{ inputs.aws_region != '' && inputs.aws_region || vars.OPENPCC_AWS_REGION || 'us-east-1' }}
      RESOLVED_SUBNET_ID: ${{ inputs.subnet_id != '' && inputs.subnet_id || vars.OPENPCC_SUBNET_ID }}
      RESOLVED_ROUTER_SECURITY_GROUP_ID: ${{ inputs.router_security_group_id != '' && inputs.router_security_group_id || vars.OPENPCC_ROUTER_SECURITY_GROUP_ID }}
      RESOLVED_COMPUTE_SECURITY_GROUP_ID: ${{ inputs.compute_security_group_id != '' && inputs.compute_security_group_id || vars.OPENPCC_COMPUTE_SECURITY_GROUP_ID }}
      RESOLVED_INSTANCE_PROFILE_ARN: ${{ inputs.instance_profile_arn != '' && inputs.instance_profile_arn || vars.OPENPCC_INSTANCE_PROFILE_ARN }}
      RESOLVED_KEY_NAME: ${{ inputs.key_name != '' && inputs.key_name || vars.OPENPCC_KEY_NAME }}
      RESOLVED_AMI_ID: ${{ inputs.ami_id != '' && inputs.ami_id || vars.OPENPCC_AMI_ID }}
      RESOLVED_ROUTER_AMI_ID: ${{ inputs.router_ami_id != '' && inputs.router_ami_id || vars.OPENPCC_ROUTER_AMI_ID }}
      RESOLVED_COMPUTE_AMI_ID: ${{ inputs.compute_ami_id != '' && inputs.compute_ami_id || vars.OPENPCC_COMPUTE_AMI_ID }}
      RESOLVED_ROUTER_INSTANCE_TYPE: ${{ inputs.router_instance_type != '' && inputs.router_instance_type || vars.OPENPCC_ROUTER_INSTANCE_TYPE || 't3.small' }}
      RESOLVED_COMPUTE_INSTANCE_TYPE: ${{ inputs.compute_instance_type != '' && inputs.compute_instance_type || vars.OPENPCC_COMPUTE_INSTANCE_TYPE || 'c5.2xlarge' }}
      RESOLVED_ENABLE_COMPUTE_MONITOR: ${{ inputs.enable_compute_monitor }}
      RESOLVED_ROUTER_ADDRESS: ${{ inputs.router_address != '' && inputs.router_address || vars.OPENPCC_ROUTER_ADDRESS }}
      RESOLVED_ENCLAVE_CPU_COUNT: ${{ inputs.enclave_cpu_count != '' && inputs.enclave_cpu_count || vars.OPENPCC_ENCLAVE_CPU_COUNT || '2' }}
      RESOLVED_ENCLAVE_MEMORY_MIB: ${{ inputs.enclave_memory_mib != '' && inputs.enclave_memory_mib || vars.OPENPCC_ENCLAVE_MEMORY_MIB || '2048' }}
      RESOLVED_ENCLAVE_CID: ${{ inputs.enclave_cid != '' && inputs.enclave_cid || vars.OPENPCC_ENCLAVE_CID || '16' }}
      RESOLVED_TPM_SIMULATOR_CMD_PORT: ${{ inputs.tpm_simulator_cmd_port != '' && inputs.tpm_simulator_cmd_port || vars.OPENPCC_TPM_SIMULATOR_CMD_PORT || '2321' }}
      RESOLVED_TPM_SIMULATOR_PLATFORM_PORT: ${{ inputs.tpm_simulator_platform_port != '' && inputs.tpm_simulator_platform_port || vars.OPENPCC_TPM_SIMULATOR_PLATFORM_PORT || '2322' }}
    permissions:
      actions: write
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.RESOLVED_AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        if: ${{ inputs.image_registry == '' && vars.OPENPCC_IMAGE_REGISTRY == '' }}
        uses: aws-actions/amazon-ecr-login@v2

      - name: Resolve image registry
        id: resolve-registry
        env:
          INPUT_IMAGE_REGISTRY: ${{ inputs.image_registry }}
          VAR_IMAGE_REGISTRY: ${{ vars.OPENPCC_IMAGE_REGISTRY }}
          PRIVATE_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          set -euo pipefail
          if [ -n "${INPUT_IMAGE_REGISTRY}" ]; then
            resolved="${INPUT_IMAGE_REGISTRY}"
          elif [ -n "${VAR_IMAGE_REGISTRY}" ]; then
            resolved="${VAR_IMAGE_REGISTRY}"
          else
            resolved="${PRIVATE_REGISTRY}"
          fi
          echo "IMAGE_REGISTRY=${resolved}" >> "$GITHUB_ENV"
          if [[ "${resolved}" == public.ecr.aws/* ]]; then
            echo "IMAGE_REGISTRY_IS_PUBLIC=true" >> "$GITHUB_ENV"
          else
            echo "IMAGE_REGISTRY_IS_PUBLIC=false" >> "$GITHUB_ENV"
          fi

      - name: Validate registry/profile combination
        env:
          INSTANCE_PROFILE_ARN: ${{ env.RESOLVED_INSTANCE_PROFILE_ARN }}
        run: |
          set -euo pipefail
          IMAGE_REGISTRY_IS_PUBLIC="${IMAGE_REGISTRY_IS_PUBLIC:-false}"
          if [ -z "${INSTANCE_PROFILE_ARN}" ] && [ "${IMAGE_REGISTRY_IS_PUBLIC}" != "true" ]; then
            echo "instance_profile_arn is empty; set image_registry to a public registry (public.ecr.aws/alias)." >&2
            exit 1
          fi

      - name: Deploy server-1
        if: ${{ inputs.component == 'server-1' || inputs.component == 'all' }}
        env:
          AWS_REGION: ${{ env.RESOLVED_AWS_REGION }}
          IMAGE_TAG: ${{ inputs.image_tag != '' && inputs.image_tag || github.sha }}
          ECR_REGISTRY: ${{ env.IMAGE_REGISTRY }}
          SUBNET_ID: ${{ env.RESOLVED_SUBNET_ID }}
          ROUTER_SECURITY_GROUP_ID: ${{ env.RESOLVED_ROUTER_SECURITY_GROUP_ID }}
          INSTANCE_PROFILE_ARN: ${{ env.RESOLVED_INSTANCE_PROFILE_ARN }}
          KEY_NAME: ${{ env.RESOLVED_KEY_NAME }}
          AMI_ID: ${{ env.RESOLVED_AMI_ID }}
          ROUTER_AMI_ID: ${{ env.RESOLVED_ROUTER_AMI_ID }}
          ROUTER_INSTANCE_TYPE: ${{ env.RESOLVED_ROUTER_INSTANCE_TYPE }}
        run: bash scripts/deploy_server1.sh

      - name: Resolve router address
        if: ${{ inputs.component == 'all' }}
        id: resolve-router
        env:
          AWS_REGION: ${{ env.RESOLVED_AWS_REGION }}
        run: |
          set -euo pipefail
          instance_id=$(aws ec2 describe-instances \
            --region "${AWS_REGION}" \
            --filters "Name=tag:Name,Values=openpcc-router" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId | [0]" \
            --output text)
          if [ -z "${instance_id}" ] || [ "${instance_id}" = "None" ]; then
            echo "Failed to find running server-1 instance (tag Name=openpcc-router)." >&2
            exit 1
          fi
          private_ip=$(aws ec2 describe-instances \
            --region "${AWS_REGION}" \
            --instance-ids "${instance_id}" \
            --query "Reservations[0].Instances[0].PrivateIpAddress" \
            --output text)
          if [ -z "${private_ip}" ] || [ "${private_ip}" = "None" ]; then
            echo "Failed to resolve router private IP." >&2
            exit 1
          fi
          router_address="http://${private_ip}:3600"
          echo "router_address=${router_address}" >> "${GITHUB_OUTPUT}"

      - name: Deploy server-2 (component=server-2)
        if: ${{ inputs.component == 'server-2' }}
        env:
          AWS_REGION: ${{ env.RESOLVED_AWS_REGION }}
          IMAGE_TAG: ${{ inputs.image_tag != '' && inputs.image_tag || github.sha }}
          ECR_REGISTRY: ${{ env.IMAGE_REGISTRY }}
          SUBNET_ID: ${{ env.RESOLVED_SUBNET_ID }}
          COMPUTE_SECURITY_GROUP_ID: ${{ env.RESOLVED_COMPUTE_SECURITY_GROUP_ID }}
          INSTANCE_PROFILE_ARN: ${{ env.RESOLVED_INSTANCE_PROFILE_ARN }}
          KEY_NAME: ${{ env.RESOLVED_KEY_NAME }}
          AMI_ID: ${{ env.RESOLVED_AMI_ID }}
          COMPUTE_AMI_ID: ${{ env.RESOLVED_COMPUTE_AMI_ID }}
          COMPUTE_INSTANCE_TYPE: ${{ env.RESOLVED_COMPUTE_INSTANCE_TYPE }}
          ENABLE_COMPUTE_MONITOR: ${{ env.RESOLVED_ENABLE_COMPUTE_MONITOR }}
          ROUTER_ADDRESS: ${{ env.RESOLVED_ROUTER_ADDRESS }}
          ENCLAVE_CPU_COUNT: ${{ env.RESOLVED_ENCLAVE_CPU_COUNT }}
          ENCLAVE_MEMORY_MIB: ${{ env.RESOLVED_ENCLAVE_MEMORY_MIB }}
          ENCLAVE_CID: ${{ env.RESOLVED_ENCLAVE_CID }}
          TPM_SIMULATOR_CMD_PORT: ${{ env.RESOLVED_TPM_SIMULATOR_CMD_PORT }}
          TPM_SIMULATOR_PLATFORM_PORT: ${{ env.RESOLVED_TPM_SIMULATOR_PLATFORM_PORT }}
        run: bash scripts/deploy_server2.sh

      - name: Deploy server-2 (component=all)
        if: ${{ inputs.component == 'all' }}
        env:
          AWS_REGION: ${{ env.RESOLVED_AWS_REGION }}
          IMAGE_TAG: ${{ inputs.image_tag != '' && inputs.image_tag || github.sha }}
          ECR_REGISTRY: ${{ env.IMAGE_REGISTRY }}
          SUBNET_ID: ${{ env.RESOLVED_SUBNET_ID }}
          COMPUTE_SECURITY_GROUP_ID: ${{ env.RESOLVED_COMPUTE_SECURITY_GROUP_ID }}
          INSTANCE_PROFILE_ARN: ${{ env.RESOLVED_INSTANCE_PROFILE_ARN }}
          KEY_NAME: ${{ env.RESOLVED_KEY_NAME }}
          AMI_ID: ${{ env.RESOLVED_AMI_ID }}
          COMPUTE_AMI_ID: ${{ env.RESOLVED_COMPUTE_AMI_ID }}
          COMPUTE_INSTANCE_TYPE: ${{ env.RESOLVED_COMPUTE_INSTANCE_TYPE }}
          ENABLE_COMPUTE_MONITOR: ${{ env.RESOLVED_ENABLE_COMPUTE_MONITOR }}
          ROUTER_ADDRESS: ${{ env.RESOLVED_ROUTER_ADDRESS != '' && env.RESOLVED_ROUTER_ADDRESS || steps.resolve-router.outputs.router_address }}
          ENCLAVE_CPU_COUNT: ${{ env.RESOLVED_ENCLAVE_CPU_COUNT }}
          ENCLAVE_MEMORY_MIB: ${{ env.RESOLVED_ENCLAVE_MEMORY_MIB }}
          ENCLAVE_CID: ${{ env.RESOLVED_ENCLAVE_CID }}
          TPM_SIMULATOR_CMD_PORT: ${{ env.RESOLVED_TPM_SIMULATOR_CMD_PORT }}
          TPM_SIMULATOR_PLATFORM_PORT: ${{ env.RESOLVED_TPM_SIMULATOR_PLATFORM_PORT }}
        run: bash scripts/deploy_server2.sh

      - name: Persist deploy defaults
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          update_var() {
            local name="$1"
            local value="$2"
            if [ -z "${value}" ]; then
              return 0
            fi
            local update_payload
            local create_payload
            update_payload=$(VAR_VALUE="${value}" python -c 'import json, os; print(json.dumps({"value": os.environ["VAR_VALUE"]}))')
            create_payload=$(VAR_NAME="${name}" VAR_VALUE="${value}" python -c 'import json, os; print(json.dumps({"name": os.environ["VAR_NAME"], "value": os.environ["VAR_VALUE"]}))')
            local api="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/variables/${name}"
            local status
            status=$(curl -sS -o /dev/null -w "%{http_code}" -X PATCH \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "${api}" \
              -d "${update_payload}")
            if [ "${status}" -eq 404 ]; then
              status=$(curl -sS -o /dev/null -w "%{http_code}" -X POST \
                -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/variables" \
                -d "${create_payload}")
            fi
            if [ "${status}" -lt 200 ] || [ "${status}" -ge 300 ]; then
              echo "Failed to upsert variable ${name} (status ${status})." >&2
              exit 1
            fi
          }
          update_var OPENPCC_AWS_REGION "${RESOLVED_AWS_REGION}"
          update_var OPENPCC_SUBNET_ID "${RESOLVED_SUBNET_ID}"
          update_var OPENPCC_ROUTER_SECURITY_GROUP_ID "${RESOLVED_ROUTER_SECURITY_GROUP_ID}"
          update_var OPENPCC_COMPUTE_SECURITY_GROUP_ID "${RESOLVED_COMPUTE_SECURITY_GROUP_ID}"
          update_var OPENPCC_INSTANCE_PROFILE_ARN "${RESOLVED_INSTANCE_PROFILE_ARN}"
          update_var OPENPCC_ROUTER_ADDRESS "${RESOLVED_ROUTER_ADDRESS}"
          update_var OPENPCC_KEY_NAME "${RESOLVED_KEY_NAME}"
          update_var OPENPCC_AMI_ID "${RESOLVED_AMI_ID}"
          update_var OPENPCC_ROUTER_AMI_ID "${RESOLVED_ROUTER_AMI_ID}"
          update_var OPENPCC_COMPUTE_AMI_ID "${RESOLVED_COMPUTE_AMI_ID}"
          update_var OPENPCC_ROUTER_INSTANCE_TYPE "${RESOLVED_ROUTER_INSTANCE_TYPE}"
          update_var OPENPCC_COMPUTE_INSTANCE_TYPE "${RESOLVED_COMPUTE_INSTANCE_TYPE}"
          update_var OPENPCC_IMAGE_REGISTRY "${IMAGE_REGISTRY}"
          update_var OPENPCC_ENCLAVE_CPU_COUNT "${RESOLVED_ENCLAVE_CPU_COUNT}"
          update_var OPENPCC_ENCLAVE_MEMORY_MIB "${RESOLVED_ENCLAVE_MEMORY_MIB}"
          update_var OPENPCC_ENCLAVE_CID "${RESOLVED_ENCLAVE_CID}"
          update_var OPENPCC_TPM_SIMULATOR_CMD_PORT "${RESOLVED_TPM_SIMULATOR_CMD_PORT}"
          update_var OPENPCC_TPM_SIMULATOR_PLATFORM_PORT "${RESOLVED_TPM_SIMULATOR_PLATFORM_PORT}"
