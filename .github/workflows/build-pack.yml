# Objective: Build/pack OpenPCC images and optional EIF artifacts.
# Usage examples:
# - Run workflow_dispatch with component=all and push=false
# - Run workflow_dispatch with component=server-2 and build_eif=true
# - Run workflow_dispatch with push=true to publish to ECR
name: OpenPCC Proto 1 Build Pack

on:
  workflow_dispatch:
    inputs:
      component:
        type: choice
        description: Component to build/package
        options:
          - all
          - client
          - server-1
          - server-2
          - server-3
        default: all
      push:
        type: boolean
        description: Push images to ECR
        default: false
      build_eif:
        type: boolean
        description: Build Nitro Enclave EIF for server-2
        default: false
      compute_eif_s3_uri:
        type: string
        description: S3 URI to upload compute EIF (required when build_eif=true)
        default: ""
      image_tag:
        type: string
        description: Image tag override (defaults to commit SHA)
        default: ""
      compute_boot_build_tags:
        type: string
        description: Optional compute_boot build tags (e.g. include_fake_attestation)
        default: ""
      aws_region:
        type: string
        description: AWS region for ECR (required when push=true)
        default: "us-east-1"

jobs:
  build-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate EIF inputs
        if: ${{ inputs.build_eif == true }}
        run: |
          if [ "${{ inputs.component }}" != "server-2" ] && [ "${{ inputs.component }}" != "all" ]; then
            echo "build_eif is only supported for component=server-2 or all."
            exit 1
          fi
          if [ "${{ inputs.push }}" != "true" ]; then
            echo "build_eif requires push=true so the EIF builder can pull from ECR."
            exit 1
          fi
          if [ -z "${{ inputs.compute_eif_s3_uri }}" ]; then
            echo "build_eif requires compute_eif_s3_uri for S3 upload."
            exit 1
          fi

      - name: Configure AWS credentials
        if: ${{ inputs.push == true }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Login to Amazon ECR
        if: ${{ inputs.push == true }}
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and package
        env:
          COMPONENT: ${{ inputs.component }}
          IMAGE_TAG: ${{ inputs.image_tag != '' && inputs.image_tag || github.sha }}
          PUSH: ${{ inputs.push }}
          REGISTRY: ${{ inputs.push && steps.login-ecr.outputs.registry || '' }}
          BUILD_EIF: "false"
          COMPUTE_BOOT_BUILD_TAGS: ${{ inputs.compute_boot_build_tags }}
        run: bash scripts/build_pack.sh

  build-eif:
    if: ${{ inputs.build_eif == true && (inputs.component == 'all' || inputs.component == 'server-2') }}
    runs-on: [self-hosted, nitro-eif]
    needs: build-images
    permissions:
      contents: read
      id-token: write
    outputs:
      compute_eif_s3_uri: ${{ steps.set-output.outputs.compute_eif_s3_uri }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build EIF and upload to S3
        env:
          IMAGE_TAG: ${{ inputs.image_tag != '' && inputs.image_tag || github.sha }}
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          COMPUTE_EIF_S3_URI: ${{ inputs.compute_eif_s3_uri }}
        run: |
          if [ -z "${COMPUTE_EIF_S3_URI}" ]; then
            echo "compute_eif_s3_uri is required when build_eif=true."
            exit 1
          fi
          compute_image_uri="${REGISTRY}/openpcc-compute:${IMAGE_TAG}"
          docker pull "${compute_image_uri}"
          sudo mkdir -p /opt/openpcc
          sudo nitro-cli build-enclave --docker-uri "${compute_image_uri}" \
            --output-file /opt/openpcc/compute.eif
          aws s3 cp /opt/openpcc/compute.eif "${COMPUTE_EIF_S3_URI}"

      - name: Set outputs
        id: set-output
        run: echo "compute_eif_s3_uri=${{ inputs.compute_eif_s3_uri }}" >> "$GITHUB_OUTPUT"
